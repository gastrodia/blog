---
// src/components/ChatWidget/index.astro
// 博客 AI 助手聊天组件
import { SITE } from "@/config";
import Icon from "@/components/Icon.astro";
---

<div 
  id="chat-widget" 
  class="fixed bottom-0 right-0 z-9999 font-mono" 
  data-site-title={SITE.title}
>
  <!-- 悬浮按钮 -->
  <button
    id="chat-button"
    aria-label="打开聊天"
    title="AI 助手"
    class="chat-button chat-hidden"
  >
    <Icon name="Robot" class="size-8" />
  </button>

  <!-- 聊天窗口 -->
  <div id="chat-window" class="chat-window chat-hidden">
    
    <!-- 标题栏 -->
    <div class="chat-header">
      <div class="m-0 text-base font-semibold flex items-center gap-2">
        <Icon name="Robot" class="size-6" />
        {SITE.title}
      </div>
      
      <div class="flex gap-2">
        <button
          id="chat-clear"
          aria-label="清空对话"
          title="清空对话"
          class="chat-icon-button"
        >
          <Icon name="Clear" class="size-4" />
        </button>
        
        <button
          id="chat-close"
          aria-label="关闭"
          title="关闭"
          class="chat-icon-button"
        >
          ✕
        </button>
      </div>
    </div>

    <!-- 消息列表 -->
    <div
      id="chat-messages"
      class="flex-1 overflow-y-auto p-4 flex flex-col gap-4 bg-background"
    ></div>

    <!-- 输入区域 -->
    <div class="p-4 bg-background border-t border-border flex gap-2">
      <input
        id="chat-input"
        type="text"
        placeholder="问我关于博客的问题..."
        aria-label="输入消息"
        maxlength="500"
        class="chat-input"
      />
      
      <button
        id="chat-send"
        aria-label="发送"
        title="发送 (Enter)"
        class="chat-send-button"
      >
        ➤
      </button>
    </div>
  </div>
</div>

<script>
  import ChatWidget from "./chat.client.ts";
  
  // ============= 类型声明 =============
  declare global {
    interface Window {
      __chatWidgetInstance?: ChatWidget;
    }
  }
  
  // ============= 辅助函数 =============
  const isDev = import.meta.env.DEV;
  
  function log(...args: unknown[]) {
    if (isDev) {
      // eslint-disable-next-line no-console
      console.log("[ChatWidget]", ...args);
    }
  }
  
  // ============= 初始化函数 =============
  function initChatWidget() {
    const widget = document.getElementById("chat-widget");
    
    if (!widget) {
      log("未找到 widget 元素");
      return;
    }
    
    const siteTitle = widget.dataset.siteTitle || "Blog";
    
    if (!window.__chatWidgetInstance) {
      log("创建新实例");
      window.__chatWidgetInstance = new ChatWidget(siteTitle);
    } else {
      log("重新初始化");
      window.__chatWidgetInstance.reinit();
    }
  }
  
  // ============= 事件监听 =============
  // 初次加载
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initChatWidget);
  } else {
    initChatWidget();
  }
  
  // 监听 Astro 客户端路由事件
  document.addEventListener("astro:page-load", () => {
    log("astro:page-load 事件触发");
    initChatWidget();
  });
</script>
