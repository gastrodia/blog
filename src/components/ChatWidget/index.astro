---
// src/components/ChatWidget/index.astro
// 博客 AI 助手聊天组件
import { SITE } from "@/config";
import Icon from "@/components/Icon.astro";
---


<div id="chat-widget" class="fixed bottom-0 right-0 z-9999 font-mono" data-site-title={SITE.title}>
  <!-- 悬浮按钮 -->
  <button
    id="chat-button"
    aria-label="打开聊天"
    title="AI 助手"
    class="chat-button chat-hidden fixed bottom-6 right-6 size-14 rounded-full flex items-center justify-center text-2xl z-10000 md:bottom-6 md:right-6 max-md:bottom-4 max-md:right-4 max-md:h-[50px] max-md:w-[50px] max-md:text-xl"
  >
    <Icon name="Robot" class="size-8" />
  </button>

  <!-- 聊天窗口 -->
  <div
    id="chat-window"
    class="chat-window chat-hidden fixed bottom-6 right-6 w-[400px] h-[600px] bg-background border border-border rounded-2xl shadow-2xl flex flex-col overflow-hidden z-9999 max-md:bottom-0 max-md:right-0 max-md:left-0 max-md:w-full max-md:h-[90vh] max-md:rounded-t-2xl max-md:rounded-b-none max-md:border-b-0"
  >
    <!-- 标题栏 -->
    <div class="px-4 py-1 bg-accent text-background flex justify-between items-center border-b border-border">
      <h3 class="m-0 text-base font-semibold flex items-center gap-2"> 
        <Icon name="Robot" class="size-6" />
        {SITE.title}</h3>
      <div class="flex gap-2">
        <button
          id="chat-clear"
          aria-label="清空对话"
          title="清空对话"
          class="border-none text-background cursor-pointer p-1 rounded transition-transform flex items-center justify-center text-xl hover:scale-110"
        >
          <Icon name="Clear" class="size-4" />
        </button>
        <button
          id="chat-close"
          aria-label="关闭"
          title="关闭"
          class="border-none text-background cursor-pointer p-1 rounded transition-transform hover:scale-110 flex items-center justify-center text-xl"
        >
          ✕
        </button>
      </div>
    </div>

    <!-- 消息列表 -->
    <div
      id="chat-messages"
      class="flex-1 overflow-y-auto p-4 flex flex-col gap-4 bg-background"
    ></div>

    <!-- 输入区域 -->
    <div class="p-4 bg-background border-t border-border flex gap-2">
      <input
        id="chat-input"
        type="text"
        placeholder="问我关于博客的问题..."
        aria-label="输入消息"
        maxlength="500"
        class="flex-1 px-3 py-2 border border-border rounded-lg bg-background text-foreground text-sm resize-none outline-none transition-colors focus:border-accent"
      />
      <button
        id="chat-send"
        aria-label="发送"
        title="发送 (Enter)"
        class="px-4 py-2 bg-accent text-background border-none rounded-lg cursor-pointer text-xl transition-all hover:opacity-90 hover:scale-105 active:scale-95 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed"
      >
        ➤
      </button>
    </div>
  </div>
</div>

<script>
  import ChatWidget from "./chat.client.ts";
  
  // 使用全局变量保存实例（确保跨页面导航保持）
  declare global {
    interface Window {
      __chatWidgetInstance?: ChatWidget;
    }
  }
  
  function initChatWidget() {
    const widget = document.getElementById("chat-widget");
    if (!widget) {
      console.log("[ChatWidget] 未找到 widget 元素");
      return;
    }
    
    const siteTitle = widget.dataset.siteTitle || "Blog";
    
    // 如果实例不存在，创建新实例
    if (!window.__chatWidgetInstance) {
      console.log("[ChatWidget] 创建新实例");
      window.__chatWidgetInstance = new ChatWidget(siteTitle);
    } else {
      // 如果实例已存在，重新初始化（用于客户端路由后）
      console.log("[ChatWidget] 重新初始化");
      window.__chatWidgetInstance.reinit();
    }
  }
  
  // 初次加载
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initChatWidget);
  } else {
    // DOM 已经加载完成
    initChatWidget();
  }
  
  // 监听 Astro 客户端路由事件（每次页面切换都会触发）
  document.addEventListener("astro:page-load", () => {
    console.log("[ChatWidget] astro:page-load 事件触发");
    initChatWidget();
  });
</script>
